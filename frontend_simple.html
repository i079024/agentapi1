<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent API Testing Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #27ae60;
        }
        
        .status-offline {
            background: #e74c3c;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .download-confirmation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .download-details {
            font-size: 14px;
            color: #495057;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Agent API Testing Platform</h1>
            <p>Complete Edition with AI-Powered Test Management & Smart Assertions</p>
            <p>
                <span class="status-indicator status-online"></span>
                Backend Status: <span id="backend-status">Checking...</span>
            </p>
            <div style="margin-top: 20px;">
                <div style="display: inline-block; margin: 5px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 0.9rem;">
                    ‚úÖ Test Management
                </div>
                <div style="display: inline-block; margin: 5px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 0.9rem;">
                    ‚úÖ AI Suggestions
                </div>
                <div style="display: inline-block; margin: 5px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 0.9rem;">
                    ‚úÖ Smart Assertions
                </div>
                <div style="display: inline-block; margin: 5px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 0.9rem;">
                    ‚úÖ Word Export
                </div>
                <div style="display: inline-block; margin: 5px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 0.9rem;">
                    ‚úÖ Batch Execution
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üéØ Choose Your Testing Approach</h2>
            <p>Select how you want to create and manage your API tests</p>
            
            <!-- Tab Navigation -->
            <div style="margin-bottom: 30px; border-bottom: 2px solid #f0f0f0;">
                <button class="tab-btn active" onclick="showTab('auto-generate')">
                    ü§ñ Auto-Generate Tests
                </button>
                <button class="tab-btn" onclick="showTab('manual-create')">
                    ‚úèÔ∏è Manual Test Creation
                </button>
                <button class="tab-btn" onclick="showTab('test-management')">
                    üìã Test Management
                </button>
                <button class="tab-btn" onclick="showTab('ai-suggestions')">
                    üß† AI Suggestions
                </button>
            </div>

            <!-- Auto-Generate Tab -->
            <div id="auto-generate" class="tab-content active">
                <h3>Repository Analysis & Auto-Generation</h3>
                <p>Enter a GitHub repository URL to analyze and automatically generate comprehensive API tests</p>
                
                <form id="analysis-form">
                    <div class="form-group">
                        <label for="github-url">GitHub Repository URL</label>
                        <input 
                            type="url" 
                            id="github-url" 
                            placeholder="https://github.com/username/repository"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="branch">Branch (optional)</label>
                        <input 
                            type="text" 
                            id="branch" 
                            placeholder="main"
                            value="main"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="test-description">Test Description (optional)</label>
                        <textarea 
                            id="test-description" 
                            rows="3"
                            placeholder="Describe what you want to test..."
                        ></textarea>
                    </div>
                    
                    <button type="submit" class="btn" id="analyze-btn">
                        üîç Analyze Repository
                    </button>
                    
                    <button type="button" class="btn" id="full-analysis-btn">
                        ‚ö° Full Analysis & Execute
                    </button>
                </form>
            </div>

            <!-- Manual Test Creation Tab -->
            <div id="manual-create" class="tab-content">
                <h3>Create Custom API Test</h3>
                <p>Manually create and configure API tests with smart assertions</p>
                
                <form id="manual-test-form">
                    <div class="form-group">
                        <label for="test-name">Test Name</label>
                        <input type="text" id="test-name" placeholder="My API Test" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 15px;">
                        <div class="form-group">
                            <label for="test-method">HTTP Method</label>
                            <select id="test-method">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="test-endpoint">Endpoint URL</label>
                            <input type="url" id="test-endpoint" placeholder="https://api.example.com/users" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="test-headers">Headers (JSON)</label>
                        <textarea id="test-headers" rows="3" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="test-body">Request Body (JSON)</label>
                        <textarea id="test-body" rows="4" placeholder='{"name": "John", "email": "john@example.com"}'></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Smart Assertions</label>
                        <div id="assertions-container">
                            <div class="assertion-item">
                                <select class="assertion-type">
                                    <option value="status_code">Status Code</option>
                                    <option value="response_time">Response Time</option>
                                    <option value="json_path">JSON Path</option>
                                    <option value="header_exists">Header Exists</option>
                                    <option value="content_type">Content Type</option>
                                </select>
                                <input type="text" class="assertion-value" placeholder="200">
                                <button type="button" onclick="removeAssertion(this)">‚ùå</button>
                            </div>
                        </div>
                        <button type="button" onclick="addAssertion()" class="btn" style="margin-top: 10px;">
                            ‚ûï Add Assertion
                        </button>
                        <button type="button" onclick="getAIAssertions()" class="btn" style="margin-top: 10px;">
                            üß† Get AI Suggestions
                        </button>
                    </div>
                    
                    <button type="submit" class="btn">
                        üíæ Save Test
                    </button>
                    
                    <button type="button" onclick="executeManualTest()" class="btn">
                        ‚ñ∂Ô∏è Save & Execute
                    </button>
                </form>
            </div>

            <!-- Test Management Tab -->
            <div id="test-management" class="tab-content">
                <h3>Manage Your Tests</h3>
                <p>View, edit, delete, and execute your saved tests</p>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="loadTests()" class="btn">üîÑ Refresh Tests</button>
                    <button onclick="exportTests()" class="btn">üì§ Export All Tests</button>
                    <button onclick="showImportDialog()" class="btn">üì• Import Tests</button>
                    <button onclick="exportWordReport()" class="btn">üìÑ Export Word Report</button>
                    <button onclick="downloadCoverageReport()" class="btn" style="background: #28a745;">üìä Download Coverage Report</button>
                    <button onclick="createSampleTests()" class="btn">üéØ Create Sample Tests</button>
                    <button onclick="showPostmanImportHelp()" class="btn">üìÇ Import Postman Collection</button>
                </div>
                
                <div id="tests-list">
                    <p>Click "Refresh Tests" to load your saved tests</p>
                </div>
            </div>

            <!-- AI Suggestions Tab -->
            <div id="ai-suggestions" class="tab-content">
                <h3>AI-Powered Test Suggestions</h3>
                <p>Get intelligent recommendations for test scenarios and assertions</p>
                
                <div class="form-group">
                    <label for="suggestion-endpoint">API Endpoint</label>
                    <input type="text" id="suggestion-endpoint" placeholder="/api/users">
                </div>
                
                <div class="form-group">
                    <label for="suggestion-method">HTTP Method</label>
                    <select id="suggestion-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="suggestion-context">Context (optional)</label>
                    <textarea id="suggestion-context" rows="3" placeholder="Describe the API endpoint purpose..."></textarea>
                </div>
                
                <button onclick="getTestSuggestions()" class="btn">
                    üß† Get Test Suggestions
                </button>
                
                <button onclick="getNextCallSuggestions()" class="btn">
                    üîÆ Get Next API Call Suggestions
                </button>
                
                <div id="ai-suggestions-results"></div>
            </div>
        </div>

        <style>
            .tab-btn {
                background: none;
                border: none;
                padding: 15px 20px;
                margin-right: 10px;
                cursor: pointer;
                font-size: 16px;
                color: #666;
                border-bottom: 3px solid transparent;
                transition: all 0.2s ease;
            }
            
            .tab-btn.active {
                color: #667eea;
                border-bottom-color: #667eea;
                font-weight: 600;
            }
            
            .tab-btn:hover {
                color: #667eea;
                background: rgba(102, 126, 234, 0.1);
            }
            
            .tab-content {
                display: none;
            }
            
            .tab-content.active {
                display: block;
            }
            
            .assertion-item {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                align-items: center;
            }
            
            .assertion-type, .assertion-value {
                flex: 1;
                margin: 0;
            }
            
            .test-item {
                border: 1px solid #e1e5e9;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                background: #f8f9fa;
            }
            
            .test-item h4 {
                margin: 0 0 10px 0;
                color: #333;
            }
            
            .test-item p {
                margin: 5px 0;
                color: #666;
                font-size: 14px;
            }
            
            .test-actions {
                margin-top: 10px;
            }
            
            .test-actions button {
                padding: 5px 10px;
                font-size: 12px;
                margin-right: 5px;
            }
        </style>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing request...</p>
        </div>
    </div>

    <script>
        // API Configuration with multiple port fallback
        let API_BASE = 'http://localhost:8000';
        const POSSIBLE_PORTS = [8000, 8001, 8002];
        
        // Enhanced backend status checking with multiple ports
        async function checkBackendStatus() {
            const statusElement = document.getElementById('backend-status');
            
            console.log('üîç Checking backend status...');
            statusElement.innerHTML = '<span style="color: orange;">üîÑ Connecting...</span>';
            
            // Try each port
            for (const port of POSSIBLE_PORTS) {
                const testUrl = `http://localhost:${port}`;
                console.log(`Trying port ${port}...`);
                
                try {
                    const response = await fetch(`${testUrl}/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors',
                        signal: AbortSignal.timeout(3000) // 3 second timeout per port
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        API_BASE = testUrl; // Update global API base
                        
                        statusElement.innerHTML = 
                            `<span style="color: green;">‚úÖ Connected</span> (Port ${port}) - ${result.message}`;
                        
                        console.log(`‚úÖ Backend connected on port ${port}`);
                        return true;
                    }
                } catch (error) {
                    console.log(`‚ùå Port ${port} failed:`, error.message);
                }
            }
            
            // No backend found on any port
            statusElement.innerHTML = `
                <span style="color: red;">‚ùå Backend Not Found</span><br>
                <small style="display: block; margin-top: 5px;">
                    <strong>Quick Fix:</strong><br>
                    1. Run: <code style="background: #f1f1f1; padding: 2px 4px;">python main_minimal_clean.py</code><br>
                    2. Or try: <code style="background: #f1f1f1; padding: 2px 4px;">./emergency_start.sh</code><br>
                    3. Check ports: ${POSSIBLE_PORTS.join(', ')}<br>
                    <button onclick="retryConnection()" style="margin-top: 5px; padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                        üîÑ Retry Connection
                    </button>
                </small>
            `;
            
            console.log('‚ùå No backend found on any port');
            return false;
        }
        
        // Manual connection retry function
        function retryConnection() {
            document.getElementById('backend-status').innerHTML = 
                '<span style="color: orange;">üîÑ Retrying connection...</span>';
            setTimeout(() => {
                checkBackendStatus();
            }, 1000);
        }
        
        // Enhanced initialization with timeout and retry
        async function initApp() {
            console.log('Initializing Agent API Testing Platform...');
            document.getElementById('backend-status').innerHTML = 
                '<span style="color: orange;">üîÑ Checking connection...</span>';
            
            // Attach form handlers
            attachFormHandlers();
            
            // Add timeout to prevent infinite checking
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Connection timeout after 10 seconds')), 10000)
            );
            
            try {
                const connected = await Promise.race([checkBackendStatus(), timeoutPromise]);
                
                if (connected) {
                    console.log('Backend connected successfully');
                    // Load initial data
                    loadTests();
                } else {
                    console.log('Backend connection failed');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('backend-status').innerHTML = 
                    `<span style="color: red;">‚ùå Connection Failed</span> - ${error.message}<br>
                    <small style="display: block; margin-top: 10px;">
                    <strong>Troubleshooting:</strong><br>
                    1. Make sure backend is running: <code>python main_minimal_clean.py</code><br>
                    2. Check if port 8000 is available<br>
                    3. Try refreshing the page<br>
                    4. Check browser console for errors (F12)
                    </small>`;
            }
            
            // Set up periodic status checks
            setInterval(async () => {
                const currentStatus = document.getElementById('backend-status').innerHTML;
                if (currentStatus.includes('‚ùå')) {
                    console.log('Retrying backend connection...');
                    await checkBackendStatus();
                }
            }, 30000); // Check every 30 seconds if disconnected
        }
        
        // Form handlers (moved to initApp function)
        function attachFormHandlers() {
            const analysisForm = document.getElementById('analysis-form');
            const fullAnalysisBtn = document.getElementById('full-analysis-btn');
            const manualTestForm = document.getElementById('manual-test-form');
            
            if (analysisForm) {
                analysisForm.addEventListener('submit', handleAnalysis);
            }
            if (fullAnalysisBtn) {
                fullAnalysisBtn.addEventListener('click', handleFullAnalysis);
            }
            if (manualTestForm) {
                manualTestForm.addEventListener('submit', handleManualTestSave);
            }
        }
        
        // NEW FEATURE FUNCTIONS
        
        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Assertion Management
        function addAssertion() {
            const container = document.getElementById('assertions-container');
            const assertionItem = document.createElement('div');
            assertionItem.className = 'assertion-item';
            assertionItem.innerHTML = `
                <select class="assertion-type">
                    <option value="status_code">Status Code</option>
                    <option value="response_time">Response Time</option>
                    <option value="json_path">JSON Path</option>
                    <option value="header_exists">Header Exists</option>
                    <option value="content_type">Content Type</option>
                    <option value="json_schema">JSON Schema</option>
                </select>
                <input type="text" class="assertion-value" placeholder="Expected value">
                <button type="button" onclick="removeAssertion(this)">‚ùå</button>
            `;
            container.appendChild(assertionItem);
        }
        
        function removeAssertion(button) {
            button.parentElement.remove();
        }
        
        // Manual Test Management
        async function handleManualTestSave(e) {
            e.preventDefault();
            
            const testData = {
                name: document.getElementById('test-name').value,
                method: document.getElementById('test-method').value,
                endpoint: document.getElementById('test-endpoint').value,
                description: `Manual test for ${document.getElementById('test-method').value} ${document.getElementById('test-endpoint').value}`,
                headers: parseJSON(document.getElementById('test-headers').value) || {},
                body: parseJSON(document.getElementById('test-body').value) || null,
                assertions: collectAssertions(),
                tags: ['manual', 'custom'],
                collection: 'manual-tests'
            };
            
            await makeRequest('/tests', testData, 'POST');
        }
        
        function collectAssertions() {
            const assertions = [];
            document.querySelectorAll('.assertion-item').forEach(item => {
                const type = item.querySelector('.assertion-type').value;
                const value = item.querySelector('.assertion-value').value;
                if (value) {
                    assertions.push({
                        type: type,
                        expected: value,
                        description: `${type} assertion`
                    });
                }
            });
            return assertions;
        }
        
        function parseJSON(str) {
            try {
                return str ? JSON.parse(str) : null;
            } catch (e) {
                return null;
            }
        }
        
        async function executeManualTest() {
            // First save the test
            await handleManualTestSave(new Event('submit'));
            // Then execute it (mock for now)
            alert('Test saved and executed! Check the results in Test Management tab.');
        }
        
        // Test Management Functions
        async function loadTests() {
            try {
                const response = await fetch(`${API_BASE}/tests`);
                const result = await response.json();
                
                if (response.ok) {
                    displayTestsList(result.tests);
                } else {
                    throw new Error(result.detail || 'Failed to load tests');
                }
            } catch (error) {
                alert(`Failed to load tests: ${error.message}`);
            }
        }
        
        function displayTestsList(tests) {
            const container = document.getElementById('tests-list');
            
            if (tests.length === 0) {
                container.innerHTML = '<p>No tests found. Create some tests first!</p>';
                return;
            }
            
            container.innerHTML = tests.map(test => `
                <div class="test-item">
                    <h4>${test.name}</h4>
                    <p><strong>Method:</strong> ${test.method} | <strong>Endpoint:</strong> ${test.endpoint}</p>
                    <p><strong>Assertions:</strong> ${test.assertions.length} | <strong>Created:</strong> ${new Date(test.created_at).toLocaleDateString()}</p>
                    <div class="test-actions">
                        <button onclick="executeTest('${test.id}')" class="btn">‚ñ∂Ô∏è Execute</button>
                        <button onclick="editTest('${test.id}')" class="btn">‚úèÔ∏è Edit</button>
                        <button onclick="deleteTest('${test.id}')" class="btn">üóëÔ∏è Delete</button>
                        <button onclick="duplicateTest('${test.id}')" class="btn">üìã Duplicate</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function executeTest(testId) {
            try {
                const response = await fetch(`${API_BASE}/execute-test/${testId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Test executed! Success: ${result.execution.success}, Time: ${result.execution.execution_time}s`);
                } else {
                    throw new Error(result.detail || 'Execution failed');
                }
            } catch (error) {
                alert(`Execution failed: ${error.message}`);
            }
        }
        
        async function deleteTest(testId) {
            if (confirm('Are you sure you want to delete this test?')) {
                try {
                    const response = await fetch(`${API_BASE}/tests/${testId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('Test deleted successfully!');
                        loadTests(); // Refresh the list
                    } else {
                        throw new Error(result.detail || 'Delete failed');
                    }
                } catch (error) {
                    alert(`Delete failed: ${error.message}`);
                }
            }
        }
        
        // Edit test function
        async function editTest(testId) {
            try {
                const response = await fetch(`${API_BASE}/tests/${testId}`);
                const result = await response.json();
                
                if (response.ok) {
                    const test = result.test;
                    
                    // Create edit form
                    const editHtml = `
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 10px 0;">
                            <h3>Edit Test: ${test.name}</h3>
                            <div class="form-group">
                                <label>Test Name:</label>
                                <input type="text" id="edit-name" value="${test.name}" style="width: 100%; padding: 8px;">
                            </div>
                            <div class="form-group">
                                <label>HTTP Method:</label>
                                <select id="edit-method" style="width: 100%; padding: 8px;">
                                    <option value="GET" ${test.method === 'GET' ? 'selected' : ''}>GET</option>
                                    <option value="POST" ${test.method === 'POST' ? 'selected' : ''}>POST</option>
                                    <option value="PUT" ${test.method === 'PUT' ? 'selected' : ''}>PUT</option>
                                    <option value="DELETE" ${test.method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                    <option value="PATCH" ${test.method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Endpoint URL:</label>
                                <input type="text" id="edit-endpoint" value="${test.endpoint}" style="width: 100%; padding: 8px;">
                            </div>
                            <div class="form-group">
                                <label>Headers (JSON):</label>
                                <textarea id="edit-headers" style="width: 100%; height: 80px; padding: 8px;">${JSON.stringify(test.headers, null, 2)}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Body (JSON):</label>
                                <textarea id="edit-body" style="width: 100%; height: 100px; padding: 8px;">${test.body ? JSON.stringify(test.body, null, 2) : ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Description:</label>
                                <textarea id="edit-description" style="width: 100%; height: 60px; padding: 8px;">${test.description}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Tags (comma-separated):</label>
                                <input type="text" id="edit-tags" value="${test.tags ? test.tags.join(', ') : ''}" style="width: 100%; padding: 8px;">
                            </div>
                            <div class="form-group">
                                <label>Collection:</label>
                                <input type="text" id="edit-collection" value="${test.collection || ''}" style="width: 100%; padding: 8px;">
                            </div>
                            <div style="margin-top: 15px;">
                                <button onclick="saveTestEdit('${testId}')" class="btn">üíæ Save Changes</button>
                                <button onclick="cancelTestEdit()" class="btn">‚ùå Cancel</button>
                                <button onclick="previewTest('${testId}')" class="btn">üëÄ Preview</button>
                            </div>
                        </div>
                    `;
                    
                    // Show edit form
                    const editContainer = document.getElementById('edit-container') || createEditContainer();
                    editContainer.innerHTML = editHtml;
                    editContainer.style.display = 'block';
                    
                    // Scroll to edit form
                    editContainer.scrollIntoView({ behavior: 'smooth' });
                    
                } else {
                    throw new Error(result.detail || 'Failed to load test');
                }
            } catch (error) {
                alert(`Failed to load test for editing: ${error.message}`);
            }
        }
        
        // Create edit container if it doesn't exist
        function createEditContainer() {
            let container = document.getElementById('edit-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'edit-container';
                container.style.display = 'none';
                container.style.margin = '20px 0';
                container.style.border = '2px solid #007bff';
                container.style.borderRadius = '8px';
                
                // Insert after test management buttons
                const testManagement = document.querySelector('.tab-content');
                testManagement.appendChild(container);
            }
            return container;
        }
        
        // Save test edit
        async function saveTestEdit(testId) {
            try {
                const updatedTest = {
                    name: document.getElementById('edit-name').value,
                    method: document.getElementById('edit-method').value,
                    endpoint: document.getElementById('edit-endpoint').value,
                    headers: JSON.parse(document.getElementById('edit-headers').value || '{}'),
                    body: document.getElementById('edit-body').value ? JSON.parse(document.getElementById('edit-body').value) : null,
                    description: document.getElementById('edit-description').value,
                    tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t),
                    collection: document.getElementById('edit-collection').value
                };
                
                const response = await fetch(`${API_BASE}/tests/${testId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedTest)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Test updated successfully!');
                    cancelTestEdit();
                    loadTests(); // Refresh the list
                } else {
                    throw new Error(result.detail || 'Failed to update test');
                }
            } catch (error) {
                alert(`Failed to update test: ${error.message}`);
            }
        }
        
        // Cancel test edit
        function cancelTestEdit() {
            const editContainer = document.getElementById('edit-container');
            if (editContainer) {
                editContainer.style.display = 'none';
                editContainer.innerHTML = '';
            }
        }
        
        // Preview test (show formatted test data)
        function previewTest(testId) {
            try {
                const updatedTest = {
                    name: document.getElementById('edit-name').value,
                    method: document.getElementById('edit-method').value,
                    endpoint: document.getElementById('edit-endpoint').value,
                    headers: JSON.parse(document.getElementById('edit-headers').value || '{}'),
                    body: document.getElementById('edit-body').value ? JSON.parse(document.getElementById('edit-body').value) : null,
                    description: document.getElementById('edit-description').value,
                    tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t),
                    collection: document.getElementById('edit-collection').value
                };
                
                alert(`Test Preview:\n\n${JSON.stringify(updatedTest, null, 2)}`);
            } catch (error) {
                alert(`Preview error: ${error.message}`);
            }
        }
        
        // Duplicate test function
        async function duplicateTest(testId) {
            try {
                const response = await fetch(`${API_BASE}/tests/${testId}`);
                const result = await response.json();
                
                if (response.ok) {
                    const originalTest = result.test;
                    
                    // Create duplicate with modified name
                    const duplicateData = {
                        ...originalTest,
                        name: `${originalTest.name} (Copy)`,
                        tags: [...(originalTest.tags || []), 'duplicate']
                    };
                    
                    // Remove id and timestamps
                    delete duplicateData.id;
                    delete duplicateData.created_at;
                    delete duplicateData.updated_at;
                    delete duplicateData.imported_at;
                    
                    const createResponse = await fetch(`${API_BASE}/tests`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(duplicateData)
                    });
                    
                    const createResult = await createResponse.json();
                    
                    if (createResponse.ok) {
                        alert('Test duplicated successfully!');
                        loadTests(); // Refresh the list
                    } else {
                        throw new Error(createResult.detail || 'Failed to duplicate test');
                    }
                } else {
                    throw new Error(result.detail || 'Failed to load test');
                }
            } catch (error) {
                alert(`Failed to duplicate test: ${error.message}`);
            }
        }
        
        // Enhanced initialization with timeout and retry
        async function initApp() {
            console.log('Initializing Agent API Testing Platform...');
            document.getElementById('backend-status').innerHTML = 
                '<span style="color: orange;">üîÑ Checking connection...</span>';
            
            // Attach form handlers
            attachFormHandlers();
            
            // Add timeout to prevent infinite checking
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Connection timeout after 10 seconds')), 10000)
            );
            
            try {
                const connected = await Promise.race([checkBackendStatus(), timeoutPromise]);
                
                if (connected) {
                    console.log('Backend connected successfully');
                    // Load initial data
                    loadTests();
                } else {
                    console.log('Backend connection failed');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('backend-status').innerHTML = 
                    `<span style="color: red;">‚ùå Connection Failed</span> - ${error.message}<br>
                    <small style="display: block; margin-top: 10px;">
                    <strong>Troubleshooting:</strong><br>
                    1. Make sure backend is running: <code>python main_minimal_clean.py</code><br>
                    2. Check if port 8000 is available<br>
                    3. Try refreshing the page<br>
                    4. Check browser console for errors (F12)
                    </small>`;
            }
            
            // Set up periodic status checks
            setInterval(async () => {
                const currentStatus = document.getElementById('backend-status').innerHTML;
                if (currentStatus.includes('‚ùå')) {
                    console.log('Retrying backend connection...');
                    await checkBackendStatus();
                }
            }, 30000); // Check every 30 seconds if disconnected
        }
        
        // Manual connection retry function
        function retryConnection() {
            document.getElementById('backend-status').innerHTML = 
                '<span style="color: orange;">üîÑ Retrying connection...</span>';
            setTimeout(() => {
                initApp();
            }, 1000);
        }
        
        // Missing functions that are called but not defined
        async function handleAnalysis(e) {
            e.preventDefault();
            const githubUrl = document.getElementById('github-url').value;
            const branch = document.getElementById('branch').value;
            const description = document.getElementById('test-description').value;
            
            try {
                // Show loading state
                const analyzeBtn = document.getElementById('analyze-btn');
                const originalText = analyzeBtn.textContent;
                analyzeBtn.textContent = 'üîç Analyzing Repository...';
                analyzeBtn.disabled = true;
                
                const response = await fetch(`${API_BASE}/analyze-repository`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        github_url: githubUrl,
                        branch: branch,
                        test_description: description
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Store coverage report ID for later use
                    if (result.coverage_report_id) {
                        sessionStorage.setItem('latest_coverage_report_id', result.coverage_report_id);
                    }
                    
                    // Display enhanced results
                    const analysisInfo = `üìä Repository Analysis Complete!
                    
üîó Repository: ${result.repository}
üåø Branch: ${result.branch}
üìà Overall Coverage: ${result.test_coverage_analysis.overall_coverage.coverage_percentage.toFixed(1)}%
üìÅ Source Files: ${result.detailed_analysis.source_files_analyzed}
üß™ Test Files: ${result.detailed_analysis.test_files_found}
üéØ Generated Tests: ${result.generated_tests.length}
‚ö†Ô∏è  Critical Gaps: ${result.detailed_analysis.critical_gaps}
üî• High Priority Gaps: ${result.detailed_analysis.high_priority_gaps}
ü§ñ AI Suggestions: ${result.ai_test_suggestions.total_suggestions}

Coverage Report ID: ${result.coverage_report_id}
Mermaid Diagram: Generated ‚úì

Use the "üìÑ Download Coverage Report" button to get detailed Word document with:
‚Ä¢ Executive Summary
‚Ä¢ File-by-file coverage analysis  
‚Ä¢ AI-powered test suggestions
‚Ä¢ Mermaid class diagrams
‚Ä¢ Improvement strategies`;
                    
                    alert(analysisInfo);
                    console.log('Analysis result:', result);
                    
                    // Update UI to show download option
                    showCoverageDownloadOption(result.coverage_report_id);
                } else {
                    throw new Error(result.detail || 'Analysis failed');
                }
            } catch (error) {
                alert(`Analysis failed: ${error.message}`);
            } finally {
                // Reset button state
                const analyzeBtn = document.getElementById('analyze-btn');
                analyzeBtn.textContent = 'üîç Analyze Repository';
                analyzeBtn.disabled = false;
            }
        }
        
        function showDownloadNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                z-index: 10001;
                max-width: 400px;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        function showCoverageDownloadOption(coverageReportId) {
            // Add download button if not already present
            const existingBtn = document.getElementById('download-coverage-btn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'download-coverage-btn';
            downloadBtn.className = 'btn';
            downloadBtn.innerHTML = 'üìÑ Download Coverage Report';
            downloadBtn.onclick = () => confirmAndDownloadCoverageReport(coverageReportId);
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.backgroundColor = '#28a745';
            downloadBtn.style.color = 'white';
            downloadBtn.style.border = 'none';
            downloadBtn.style.borderRadius = '4px';
            downloadBtn.style.padding = '8px 16px';
            downloadBtn.style.cursor = 'pointer';
            
            // Add after the analyze button
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.parentNode.insertBefore(downloadBtn, analyzeBtn.nextSibling);
        }
        
        async function confirmAndDownloadCoverageReport(coverageReportId) {
            try {
                // Show a more detailed confirmation dialog
                const confirmDialog = `ü§î Download Coverage Analysis Report?
                
This will generate and download a comprehensive Word document containing:

üìä Executive Summary
   ‚Ä¢ Overall coverage percentage and key metrics
   ‚Ä¢ Critical findings and priority gaps
   ‚Ä¢ Coverage grade and recommendations

üîç Repository Analysis  
   ‚Ä¢ File structure and framework detection
   ‚Ä¢ Detected API endpoints
   ‚Ä¢ Source and test file analysis

üìà Detailed Coverage Analysis
   ‚Ä¢ File-by-file coverage breakdown
   ‚Ä¢ Class and method coverage details
   ‚Ä¢ Gap identification with priorities

ü§ñ AI-Powered Recommendations
   ‚Ä¢ Specific test case suggestions
   ‚Ä¢ Implementation priorities and effort estimates
   ‚Ä¢ Improvement strategies

üé® Visual Diagrams
   ‚Ä¢ Mermaid class diagrams with coverage indicators
   ‚Ä¢ Dependency relationship maps

üìã Implementation Roadmap
   ‚Ä¢ Step-by-step improvement plan
   ‚Ä¢ Success metrics and milestones

The document will be 2-5 MB and saved to your Downloads folder.

Do you want to proceed with the download?`;
                
                const userConfirmed = confirm(confirmDialog);
                
                if (userConfirmed) {
                    // Store the coverage report ID and proceed with download
                    sessionStorage.setItem('latest_coverage_report_id', coverageReportId);
                    await downloadCoverageReport();
                }
            } catch (error) {
                alert(`Error preparing download: ${error.message}`);
            }
        }
        
        async function handleFullAnalysis() {
            const githubUrl = document.getElementById('github-url').value;
            if (!githubUrl) {
                alert('Please enter a GitHub URL first');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/full-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        github_url: githubUrl,
                        branch: document.getElementById('branch').value
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Full analysis complete! Repository: ${result.repository}`);
                } else {
                    throw new Error(result.detail || 'Full analysis failed');
                }
            } catch (error) {
                alert(`Full analysis failed: ${error.message}`);
            }
        }
        
        async function makeRequest(endpoint, data, method = 'POST') {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message || 'Operation completed'}`);
                    return result;
                } else {
                    throw new Error(result.detail || 'Request failed');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                throw error;
            }
        }
        
        async function exportTests() {
            try {
                const response = await fetch(`${API_BASE}/export/tests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Create download
                    const blob = new Blob([JSON.stringify(result.export_data, null, 2)], 
                        { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.download_filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`Exported ${result.export_data.export_info.total_tests} tests!`);
                } else {
                    throw new Error(result.detail || 'Export failed');
                }
            } catch (error) {
                alert(`Export failed: ${error.message}`);
            }
        }
        
        // Enhanced import dialog
        function showImportDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importData = JSON.parse(e.target.result);
                            console.log('Importing file:', file.name, 'Data:', importData);
                            
                            // Check if it's a Postman collection
                            if (importData.info && importData.item) {
                                console.log('Detected Postman collection:', importData.info.name);
                                if (confirm(`Detected Postman Collection: "${importData.info.name}"\n\nThis will convert ${importData.item.length} items to API tests.\n\nProceed with import?`)) {
                                    importTests(importData);
                                }
                            } else {
                                importTests(importData);
                            }
                        } catch (error) {
                            alert(`Failed to parse JSON file: ${error.message}`);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        async function importTests(importData) {
            try {
                console.log('Importing data:', importData);
                
                // Send the data directly to the backend - let it handle format detection
                const response = await fetch(`${API_BASE}/import/tests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tests: importData })
                });
                
                const result = await response.json();
                console.log('Import response:', result);
                
                if (response.ok) {
                    let message = `Successfully imported ${result.imported_tests} test(s)!`;
                    if (result.errors && result.errors.length > 0) {
                        message += `\n\nWarnings:\n${result.errors.slice(0, 5).join('\n')}`;
                        if (result.errors.length > 5) {
                            message += `\n... and ${result.errors.length - 5} more errors`;
                        }
                    }
                    alert(message);
                    loadTests(); // Refresh the list
                } else {
                    throw new Error(result.detail || 'Import failed');
                }
            } catch (error) {
                console.error('Import error:', error);
                
                // Provide helpful error messages
                let errorMessage = error.message;
                if (errorMessage.includes('Invalid import format')) {
                    errorMessage += '\n\nTip: Make sure your JSON file contains:\n' +
                                  '‚Ä¢ An array of test objects, OR\n' +
                                  '‚Ä¢ An export file with "tests" array, OR\n' +
                                  '‚Ä¢ A single test object with "name" and "endpoint"';
                }
                
                alert(`Import failed: ${errorMessage}`);
            }
        }
        
        async function exportWordReport() {
            try {
                const response = await fetch(`${API_BASE}/export/results/word`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ include_charts: true })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Word report generated: ${result.document.filename}\nPages: ${result.document.pages}`);
                } else {
                    throw new Error(result.detail || 'Word export failed');
                }
            } catch (error) {
                alert(`Word export failed: ${error.message}`);
            }
        }
        
        async function downloadCoverageReport() {
            try {
                // Get the latest coverage report ID from sessionStorage if available
                const coverageReportId = sessionStorage.getItem('latest_coverage_report_id');
                
                if (!coverageReportId) {
                    alert('No coverage report available. Please analyze a repository first.');
                    return;
                }
                
                // First, prepare the report
                const response = await fetch(`${API_BASE}/export/coverage-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        coverage_report_id: coverageReportId,
                        include_mermaid_diagram: true,
                        include_ai_suggestions: true
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const summary = result.summary;
                    const confirmation = result.download_confirmation;
                    
                    // Show confirmation dialog with details
                    const confirmMessage = `üìä Coverage Analysis Report Ready for Download!
                    
üìÅ Repository: ${summary.repository}
üåø Branch: ${summary.branch}
üìà Overall Coverage: ${summary.overall_coverage_percentage}%
üìä Files Analyzed: ${summary.total_files_analyzed}
‚ö†Ô∏è  Critical Gaps: ${summary.critical_gaps}
ü§ñ AI Suggestions: ${summary.ai_suggestions}
üìÑ Mermaid Diagram: ${summary.mermaid_diagram_included ? 'Included' : 'Not included'}

üìÑ File Details:
‚Ä¢ Filename: ${result.document.filename}
‚Ä¢ Pages: ${result.document.pages}
‚Ä¢ Estimated Size: ${confirmation.file_size_estimate}
‚Ä¢ Sections: ${result.document.sections.join(', ')}

üìã Report Includes:
${confirmation.includes.filter(item => item !== null).map(item => `‚Ä¢ ${item}`).join('\n')}

Do you want to download this comprehensive coverage report?`;
                    
                    const userConfirmed = confirm(confirmMessage);
                    
                    if (userConfirmed) {
                        // User confirmed, proceed with download
                        await performActualDownload(result.document.document_id, result.download_filename);
                    } else {
                        // User cancelled
                        alert('Download cancelled. The report is still available and can be downloaded later.');
                    }
                } else {
                    throw new Error(result.detail || 'Coverage report export failed');
                }
            } catch (error) {
                alert(`Coverage report export failed: ${error.message}`);
            }
        }
        
        async function performActualDownload(documentId, filename) {
            try {
                // Show download progress
                showDownloadProgress(true);
                
                // Download the file
                const downloadResponse = await fetch(`${API_BASE}/download/coverage/${documentId}`, {
                    method: 'GET'
                });
                
                if (downloadResponse.ok) {
                    // Create blob and download
                    const blob = await downloadResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create temporary download link
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Show success message
                    showDownloadProgress(false);
                    showDownloadNotification(`‚úÖ Coverage report downloaded successfully!
üìÑ File: ${filename}
üíæ Saved to your Downloads folder`, 'success');
                    
                    // Store download info
                    const downloadInfo = {
                        filename: filename,
                        downloadedAt: new Date().toISOString(),
                        documentId: documentId
                    };
                    sessionStorage.setItem('latest_download', JSON.stringify(downloadInfo));
                    
                } else {
                    throw new Error('Download failed from server');
                }
                
            } catch (error) {
                showDownloadProgress(false);
                alert(`Download failed: ${error.message}`);
            }
        }
        
        function showDownloadProgress(show) {
            // Create or remove progress indicator
            const existingProgress = document.getElementById('download-progress');
            
            if (show) {
                if (!existingProgress) {
                    const progressDiv = document.createElement('div');
                    progressDiv.id = 'download-progress';
                    progressDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border: 2px solid #007bff;
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                        z-index: 10000;
                        text-align: center;
                    `;
                    progressDiv.innerHTML = `
                        <div style="margin-bottom: 10px;">üìÑ Preparing Coverage Report...</div>
                        <div style="font-size: 12px; color: #666;">Generating comprehensive analysis document</div>
                        <div style="margin-top: 10px;">
                            <div style="width: 200px; height: 4px; background: #eee; border-radius: 2px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: #007bff; animation: pulse 1.5s infinite;"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(progressDiv);
                }
            } else {
                if (existingProgress) {
                    existingProgress.remove();
                }
            }
        }
        
        async function createSampleTests() {
            try {
                const response = await fetch(`${API_BASE}/create-sample-tests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Created ${result.created_tests.length} sample tests!`);
                    loadTests(); // Refresh the list
                } else {
                    throw new Error(result.detail || 'Sample creation failed');
                }
            } catch (error) {
                alert(`Sample creation failed: ${error.message}`);
            }
        }
        
        // Show Postman import help
        function showPostmanImportHelp() {
            alert(`üìÇ Postman Collection Import Guide:

1. Export from Postman:
   ‚Ä¢ File ‚Üí Export ‚Üí Collection v2.1 (recommended)
   ‚Ä¢ Save as JSON file

2. Import to API Testing Platform:
   ‚Ä¢ Click "Import Tests" button
   ‚Ä¢ Select your exported Postman collection JSON file
   ‚Ä¢ The platform will automatically convert:
     ‚úÖ Requests ‚Üí API Tests
     ‚úÖ Headers ‚Üí Test Headers
     ‚úÖ Body ‚Üí Test Body (JSON, form-data, x-www-form-urlencoded)
     ‚úÖ Test Scripts ‚Üí Smart Assertions
     ‚úÖ Folders ‚Üí Test Collections

3. Supported Features:
   ‚Ä¢ GET, POST, PUT, DELETE, PATCH methods
   ‚Ä¢ Headers and authentication
   ‚Ä¢ JSON, form data, and URL-encoded bodies
   ‚Ä¢ Basic test script conversion to assertions
   ‚Ä¢ Folder structure preservation
   ‚Ä¢ Environment variables (converted to static values)

4. After Import:
   ‚Ä¢ Tests appear in "Test Management" tab
   ‚Ä¢ Organized by collection name
   ‚Ä¢ Tagged with "postman" and "imported"
   ‚Ä¢ Ready to execute individually or in batches

Try it now with your Postman collections!`);
        }
        
        async function getAIAssertions() {
            const endpoint = document.getElementById('test-endpoint').value;
            const method = document.getElementById('test-method').value;
            
            if (!endpoint) {
                alert('Please enter an endpoint first');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/ai-suggestions/assertions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint, method })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Add suggested assertions to the form
                    result.assertion_suggestions.forEach(suggestion => {
                        addAssertion();
                        const items = document.querySelectorAll('.assertion-item');
                        const lastItem = items[items.length - 1];
                        lastItem.querySelector('.assertion-type').value = suggestion.type;
                        lastItem.querySelector('.assertion-value').value = suggestion.config.expected || suggestion.config.max_ms || '';
                    });
                    
                    alert(`Added ${result.assertion_suggestions.length} AI-suggested assertions!`);
                } else {
                    throw new Error(result.detail || 'AI suggestions failed');
                }
            } catch (error) {
                alert(`AI suggestions failed: ${error.message}`);
            }
        }
        
        async function getTestSuggestions() {
            const endpoint = document.getElementById('suggestion-endpoint').value;
            const method = document.getElementById('suggestion-method').value;
            const context = document.getElementById('suggestion-context').value;
            
            try {
                const response = await fetch(`${API_BASE}/ai-suggestions/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint, method, context })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const resultsDiv = document.getElementById('ai-suggestions-results');
                    resultsDiv.innerHTML = `
                        <h4>AI Test Suggestions</h4>
                        ${result.suggestions.map(suggestion => `
                            <div class="test-item">
                                <h4>${suggestion.name}</h4>
                                <p>${suggestion.description}</p>
                                <p><strong>Method:</strong> ${suggestion.method} | <strong>Endpoint:</strong> ${suggestion.endpoint}</p>
                                <p><strong>Confidence:</strong> ${(suggestion.confidence * 100).toFixed(0)}%</p>
                            </div>
                        `).join('')}
                    `;
                } else {
                    throw new Error(result.detail || 'Test suggestions failed');
                }
            } catch (error) {
                alert(`Test suggestions failed: ${error.message}`);
            }
        }
        
        async function getNextCallSuggestions() {
            const endpoint = document.getElementById('suggestion-endpoint').value;
            const method = document.getElementById('suggestion-method').value;
            
            try {
                const response = await fetch(`${API_BASE}/ai-suggestions/next-calls`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint, method })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const resultsDiv = document.getElementById('ai-suggestions-results');
                    resultsDiv.innerHTML = `
                        <h4>Next API Call Suggestions</h4>
                        ${result.next_call_suggestions.map(suggestion => `
                            <div class="test-item">
                                <h4>${suggestion.method} ${suggestion.endpoint}</h4>
                                <p>${suggestion.description}</p>
                                <p><strong>Reasoning:</strong> ${suggestion.reasoning}</p>
                                <p><strong>Confidence:</strong> ${(suggestion.confidence * 100).toFixed(0)}%</p>
                            </div>
                        `).join('')}
                    `;
                } else {
                    throw new Error(result.detail || 'Next call suggestions failed');
                }
            } catch (error) {
                alert(`Next call suggestions failed: ${error.message}`);
            }
        }
        
        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting initialization...');
            initApp();
        });
        
        // Also try immediate initialization in case DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // DOM is already loaded
            initApp();
        }
    </script>
</body>
</html>